# RabbitMesh Blog Platform Makefile
# Makes it easy to start/stop all microservices

.PHONY: help start stop status logs clean build check deps rabbitmq rabbitmq-stop restart

# Default target
help: ## Show this help message
	@echo "ğŸš€ RabbitMesh Blog Platform - Service Management"
	@echo ""
	@echo "Available commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "Example workflow:"
	@echo "  make deps          # Install dependencies"  
	@echo "  make rabbitmq      # Start RabbitMQ"
	@echo "  make start         # Start all services"
	@echo "  make logs          # View service logs"
	@echo "  make stop          # Stop all services"

# Dependency management
deps: ## Install and check dependencies
	@echo "ğŸ“¦ Checking dependencies..."
	@which docker >/dev/null || (echo "âŒ Docker not found. Please install Docker first." && exit 1)
	@echo "âœ… Docker found"
	@which cargo >/dev/null || (echo "âŒ Cargo not found. Please install Rust first." && exit 1)  
	@echo "âœ… Cargo found"
	@echo "ğŸ”§ Building all services..."
	@cargo build
	@echo "âœ… All dependencies ready!"

# RabbitMQ management
rabbitmq: ## Start RabbitMQ in Docker
	@echo "ğŸ° Starting RabbitMQ..."
	@if docker ps --format "{{.Ports}}" | grep -q "5672->5672"; then \
		echo "âœ… RabbitMQ already running on port 5672"; \
	else \
		docker run -d \
			--name rabbitmq-blog \
			-p 5672:5672 \
			-p 15672:15672 \
			rabbitmq:3-management; \
		echo "âœ… RabbitMQ started"; \
	fi
	@echo "ğŸ“‹ AMQP: localhost:5672, Management UI: http://localhost:15672 (guest/guest)"

rabbitmq-stop: ## Stop RabbitMQ Docker container
	@echo "ğŸ›‘ Stopping RabbitMQ..."
	@docker stop rabbitmq-blog 2>/dev/null || true
	@docker rm rabbitmq-blog 2>/dev/null || true
	@echo "âœ… RabbitMQ stopped"

rabbitmq-status: ## Check RabbitMQ status
	@echo "ğŸ° RabbitMQ Status:"
	@docker ps --filter "publish=5672" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null | head -n 10 || echo "âŒ No RabbitMQ container found on port 5672"

# Service management
start: rabbitmq ## Start all microservices
	@echo "ğŸš€ Starting Blog Platform Services..."
	@echo ""
	@echo "ğŸ“ Starting services in background..."
	@mkdir -p logs
	@cargo run --bin auth-service > logs/auth-service.log 2>&1 & echo $$! > logs/auth-service.pid
	@sleep 2
	@cargo run --bin post-service > logs/post-service.log 2>&1 & echo $$! > logs/post-service.pid  
	@sleep 2
	@cargo run --bin comment-service > logs/comment-service.log 2>&1 & echo $$! > logs/comment-service.pid
	@sleep 2
	@cargo run --bin blog-api-gateway > logs/api-gateway.log 2>&1 & echo $$! > logs/api-gateway.pid
	@sleep 3
	@echo ""
	@echo "âœ… All services started!"
	@echo ""
	@echo "ğŸŒ API Gateway: http://localhost:3334"
	@echo "ğŸ“‹ API Docs: http://localhost:3334/docs"  
	@echo "ğŸ”— OpenAPI Spec: http://localhost:3334/api-docs/openapi.json"
	@echo "ğŸ° RabbitMQ UI: http://localhost:15672 (guest/guest)"
	@echo ""
	@echo "ğŸ“Š Use 'make status' to check service health"
	@echo "ğŸ“œ Use 'make logs' to view service logs"

stop: ## Stop all microservices
	@echo "ğŸ›‘ Stopping Blog Platform Services..."
	@if [ -f logs/auth-service.pid ]; then kill -TERM $$(cat logs/auth-service.pid) 2>/dev/null || true; rm -f logs/auth-service.pid; fi
	@if [ -f logs/post-service.pid ]; then kill -TERM $$(cat logs/post-service.pid) 2>/dev/null || true; rm -f logs/post-service.pid; fi
	@if [ -f logs/comment-service.pid ]; then kill -TERM $$(cat logs/comment-service.pid) 2>/dev/null || true; rm -f logs/comment-service.pid; fi
	@if [ -f logs/api-gateway.pid ]; then kill -TERM $$(cat logs/api-gateway.pid) 2>/dev/null || true; rm -f logs/api-gateway.pid; fi
	@sleep 2
	@pkill -f "cargo run --bin.*-service" 2>/dev/null || true
	@pkill -f "blog-api-gateway" 2>/dev/null || true
	@echo "âœ… All services stopped"

restart: stop start ## Restart all services

status: ## Check status of all services
	@echo "ğŸ“Š Blog Platform Status:"
	@echo ""
	@echo "ğŸ° RabbitMQ:"
	@docker ps --filter "publish=5672" --format "  âœ… {{.Names}} - {{.Status}}" 2>/dev/null | head -n 1 || echo "  âŒ RabbitMQ not running on port 5672"
	@echo ""
	@echo "ğŸ”§ Microservices:"
	@if [ -f logs/auth-service.pid ] && kill -0 $$(cat logs/auth-service.pid) 2>/dev/null; then echo "  âœ… Auth Service - Running (PID: $$(cat logs/auth-service.pid))"; else echo "  âŒ Auth Service - Not running"; fi
	@if [ -f logs/post-service.pid ] && kill -0 $$(cat logs/post-service.pid) 2>/dev/null; then echo "  âœ… Post Service - Running (PID: $$(cat logs/post-service.pid))"; else echo "  âŒ Post Service - Not running"; fi
	@if [ -f logs/comment-service.pid ] && kill -0 $$(cat logs/comment-service.pid) 2>/dev/null; then echo "  âœ… Comment Service - Running (PID: $$(cat logs/comment-service.pid))"; else echo "  âŒ Comment Service - Not running"; fi  
	@if [ -f logs/api-gateway.pid ] && kill -0 $$(cat logs/api-gateway.pid) 2>/dev/null; then echo "  âœ… API Gateway - Running (PID: $$(cat logs/api-gateway.pid))"; else echo "  âŒ API Gateway - Not running"; fi
	@echo ""
	@echo "ğŸŒ Service Health Checks:"
	@curl -s http://localhost:3334/health >/dev/null 2>&1 && echo "  âœ… Gateway Health - OK" || echo "  âŒ Gateway Health - Failed"
	@curl -s http://localhost:3334/health/auth-service >/dev/null 2>&1 && echo "  âœ… Auth Service Health - OK" || echo "  âŒ Auth Service Health - Failed"
	@curl -s http://localhost:3334/health/post-service >/dev/null 2>&1 && echo "  âœ… Post Service Health - OK" || echo "  âŒ Post Service Health - Failed"
	@curl -s http://localhost:3334/health/comment-service >/dev/null 2>&1 && echo "  âœ… Comment Service Health - OK" || echo "  âŒ Comment Service Health - Failed"

logs: ## View logs from all services
	@echo "ğŸ“œ Service Logs (Ctrl+C to exit):"
	@echo ""
	@if [ -d logs ]; then \
		echo "ğŸ” Auth Service Logs:"; echo "================"; tail -n 10 logs/auth-service.log 2>/dev/null || echo "No logs found"; echo ""; \
		echo "ğŸ“ Post Service Logs:"; echo "================"; tail -n 10 logs/post-service.log 2>/dev/null || echo "No logs found"; echo ""; \
		echo "ğŸ’¬ Comment Service Logs:"; echo "=================="; tail -n 10 logs/comment-service.log 2>/dev/null || echo "No logs found"; echo ""; \
		echo "ğŸŒ API Gateway Logs:"; echo "==============="; tail -n 10 logs/api-gateway.log 2>/dev/null || echo "No logs found"; echo ""; \
		echo "ğŸ“¡ Follow live logs with:"; \
		echo "  tail -f logs/auth-service.log"; \
		echo "  tail -f logs/post-service.log"; \
		echo "  tail -f logs/comment-service.log"; \
		echo "  tail -f logs/api-gateway.log"; \
	else \
		echo "âŒ No logs directory found. Start services first with 'make start'"; \
	fi

logs-follow: ## Follow live logs from all services
	@echo "ğŸ“¡ Following live logs (Ctrl+C to exit):"
	@if [ -d logs ]; then \
		tail -f logs/*.log; \
	else \
		echo "âŒ No logs directory found. Start services first with 'make start'"; \
	fi

# Development helpers  
build: ## Build all services
	@echo "ğŸ”§ Building all services..."
	@cargo build
	@echo "âœ… Build complete"

check: ## Run tests and checks
	@echo "ğŸ” Running tests and checks..."
	@cargo test
	@cargo clippy
	@echo "âœ… All checks passed"

clean: ## Clean build artifacts and logs
	@echo "ğŸ§¹ Cleaning up..."
	@cargo clean
	@rm -rf logs
	@echo "âœ… Cleanup complete"

# Quick test commands
test-api: ## Quick API test (requires services to be running)
	@echo "ğŸ§ª Testing API endpoints..."
	@echo "1. Testing health endpoints:"
	@curl -s http://localhost:3334/health | jq . || echo "âŒ Gateway health failed"
	@curl -s http://localhost:3334/health/auth-service | jq . || echo "âŒ Auth service health failed"
	@echo ""
	@echo "2. Testing user registration:"
	@curl -s -X POST http://localhost:3334/api/v1/auth-service/register \
		-H 'Content-Type: application/json' \
		-d '{"username":"testuser","email":"test@example.com","password":"test123"}' | jq . || echo "âŒ User registration failed"
	@echo ""
	@echo "3. Testing posts list:"
	@curl -s http://localhost:3334/api/v1/post-service/list_posts | jq . || echo "âŒ Posts list failed"
	@echo ""
	@echo "âœ… API test complete"

# Development workflow
dev: ## Start development environment
	@echo "ğŸ”§ Starting development environment..."
	@make deps
	@make rabbitmq
	@sleep 3
	@make start
	@echo ""
	@echo "ğŸ‰ Development environment ready!"
	@echo "ğŸ“‹ Open API docs: http://localhost:3334/docs"

# Production-like commands
production-stop: rabbitmq-stop stop clean ## Full cleanup for production

info: ## Show useful information
	@echo "â„¹ï¸  RabbitMesh Blog Platform Information"
	@echo ""
	@echo "ğŸŒ Endpoints:"
	@echo "  API Gateway:     http://localhost:3334"
	@echo "  API Docs:        http://localhost:3334/docs"
	@echo "  OpenAPI Spec:    http://localhost:3334/api-docs/openapi.json"
	@echo "  RabbitMQ UI:     http://localhost:15672 (guest/guest)"
	@echo ""
	@echo "ğŸ”— Service Architecture:"
	@echo "  Auth Service:    Zero ports (RabbitMQ only)"
	@echo "  Post Service:    Zero ports (RabbitMQ only)"
	@echo "  Comment Service: Zero ports (RabbitMQ only)"
	@echo "  API Gateway:     Port 3334 (Only HTTP port in system)"
	@echo ""
	@echo "ğŸ’¬ Inter-Service Communication:"
	@echo "  Comment â†’ Auth (token validation)"
	@echo "  Comment â†’ Post (post verification)"
	@echo "  Post â†’ Auth (user authentication)"
	@echo ""
	@echo "ğŸ“ File Structure:"
	@echo "  blog-common/     - Shared utilities & models"  
	@echo "  auth-service/    - User management"
	@echo "  post-service/    - Blog posts"
	@echo "  comment-service/ - Comments with multi-service calls"
	@echo "  api-gateway/     - HTTP gateway with OpenAPI docs"